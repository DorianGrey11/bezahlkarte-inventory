{% extends "base.html" %}
{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="/">Home</a> &rsaquo;
    <a href="/?collection={{ collection.id }}"> {{ collection.name }}</a> &rsaquo;
    <a href="/collections/{{ collection.id }}"> bearbeiten </a> &rsaquo;
</div>
{% endblock %}
{% block content %}
<h2>Bestand aktualisieren für {{ collection.name }}</h2>

<form method="post">
    {% csrf_token %}

    <table border="1" cellpadding="8" cellspacing="0">
        <thead>
        <tr>
            <th>Konto</th>
            {% for account in accounts %}
            <th>{{ account.name }}</th>
            {% endfor %}
        </tr>
        </thead>
        <tr>
            <th>Aktueller Bestand</th>
            {% for account in accounts %}
            <td>{{ account.balance }} €</td>
            {% endfor %}
        </tr>
        <tr>
            <th>Neuer Bestand</th>
            {% for account in accounts %}
            <td>
                <input type="number" step="0.01" name="account_{{ account.id }}" value="{{ account.balance }}">
            </td>
            {% endfor %}
        </tr>
    </table>

    <h2><input type="checkbox" id="toggleTransfer" name="enable_transfer"> (Optional) Transfer von {{ collection.name }}
        auf ein anderes Konto/Kasse</h2>
    <div id="transferSection" style="display: none;margin-top: 1em;">
        <p>Hinweis: Der Transfer auf andere Konten findet nach der Bilanzierung innerhalb von {{ collection.name }} statt. Gib oben bei Neuer Betrag also den Betrag an bevor die Gutscheine/das Geld für den Transfer entnommen wurden </p>
        <table border="1" cellpadding="8" cellspacing="0">
            <thead>
            <tr>
                <th>Konto</th>
                {% for account in accounts %}
                <th>{{ account.name }}</th>
                {% endfor %}
            </tr>
            </thead>
            <tr>
                <th>Zielkonto</th>
                {% for account in accounts %}
                <td>
                    <select name="transfer_target_{{ account.id }}">
                        <option value="">—</option>
                        {% for target in external_accounts %}
                        <option value="{{ target.id }}">{{ target.collection.name }} – {{ target.name }}</option>
                        {% endfor %}
                    </select>
                </td>
                {% endfor %}
            </tr>
            <tr>
                <th> Transfer-Betrag</th>
                {% for account in accounts %}
                <td>
                    <input type="number" step="0.01" name="transfer_amount_{{ account.id }}">
                </td>
                {% endfor %}
            </tr>
        </table>
    </div>


    <br>
    {% if balance_mismatch %}
    <div style="margin: 1em 0; padding: 1em; border: 1px solid red; background-color: #fbeaea;">
        <p><strong>Warnung:</strong> Der Saldo wich um {{ balance_mismatch|floatformat:2 }} € ab.</p>
        <p>Bitte Überprüfe die Eingabe noch einmal. Notfalls kann der Fehlbetrag auf das Fehlbetragskonto gebucht werden.</p>
        <input type="checkbox" name="correction" value="true" id="correction">
        <label for="correction">Fehlbetrag auf das Fehlbetrag-Konto buchen</label>
    </div>
    {% endif %}

    <label for="transaction_description">Transaktionsbeschreibung:</label>
    <input type="text" id="transaction_description" name="transaction_description" size=50 value="Gutscheintausch am {{ now|date:'d.m.Y' }}">
    <br/><br/>
    <button type="submit">Neuen Bestand Speichern</button>
</form>

<h2><input type="checkbox" id="toggleAddGiftCard" name="enable_add_gift_card"> Neue Gutscheinart zu {{ collection.name }} hinzufügen</h2>
<form id="addGiftCardForm" method="post" style="display: none; margin-bottom: 1em;">
    {% csrf_token %}
    <label for="add_account_name">Gutscheinname:</label>
    <input type="text"  id="add_account_name" name="add_account_name" value="Gutschein">

    <button type="submit" name="add_account" value="1">hinzufügen</button>
</form>


<script>
    const transferCheckbox = document.getElementById("toggleTransfer");
    const transferSection = document.getElementById("transferSection");
    const addGiftCardCheckbox = document.getElementById("toggleAddGiftCard");
    const addGiftCardForm = document.getElementById("addGiftCardForm");
    transferCheckbox.addEventListener("change", () => {
        transferSection.style.display = transferCheckbox.checked ? "block" : "none";
    });
    addGiftCardCheckbox.addEventListener("change", () => {
        addGiftCardForm.style.display = addGiftCardCheckbox.checked ? "block" : "none";
    });
</script>


{% endblock %}
